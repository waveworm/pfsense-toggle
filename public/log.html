<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Log — Kids Internet</title>
    <meta name="theme-color" content="#0d0f14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KidsNet">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { overscroll-behavior: none; }

        body {
            background: #0d0f14;
            color: #e0e0e0;
            font-family: 'Barlow', sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #1a1f28;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: color 200ms;
        }
        .back-link:hover { color: #e0e0e0; }

        .header-divider { width: 1px; height: 20px; background: #2a3038; }

        .header-title h1 {
            font-size: 22px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .nav-link {
            font-family: 'Barlow', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #555;
            text-decoration: none;
            padding: 6px 12px;
            border: 1px solid #2a3038;
            border-radius: 4px;
            transition: all 200ms;
        }
        .nav-link:hover { color: #e0e0e0; border-color: #3a4048; background: #1a1f28; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-info {
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            color: #444;
        }

        /* Log entries */
        .log-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .log-entry {
            display: grid;
            grid-template-columns: 90px 80px 140px 1fr;
            gap: 12px;
            align-items: center;
            padding: 8px 12px;
            background: #16191f;
            border: 1px solid #1a1f28;
            border-radius: 4px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
        }

        .log-time { color: #555; white-space: nowrap; }
        .log-kid  { color: #e0e0e0; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .log-action { font-size: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 3px 7px; border-radius: 3px; text-align: center; }
        .log-details { color: #555; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Action color classes */
        .action-allow      { background: rgba(34,197,94,0.12);  color: #22c55e; }
        .action-block      { background: rgba(239,68,68,0.10);   color: #ef4444; }
        .action-timed      { background: rgba(245,158,11,0.12);  color: #f59e0b; }
        .action-neutral    { background: rgba(100,100,100,0.12); color: #888; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            color: #333;
        }

        /* Weekly table */
        .weekly-section {
            margin-bottom: 24px;
        }

        .weekly-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .weekly-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
        }

        .weekly-table th {
            text-align: center;
            padding: 6px 4px;
            color: #444;
            font-weight: 400;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #1a1f28;
        }

        .weekly-table th.col-name { text-align: left; padding-left: 12px; }

        .weekly-table td {
            text-align: center;
            padding: 7px 4px;
            border-bottom: 1px solid #1a1f28;
            color: #555;
        }

        .weekly-table td.col-name {
            text-align: left;
            padding-left: 12px;
            color: #e0e0e0;
            font-weight: 700;
        }

        .weekly-table td.col-today { background: #1a1f28; }
        .weekly-table th.col-today { background: #1a1f28; color: #888; }

        .cell-mins { color: #f59e0b; }
        .cell-zero { color: #2a3038; }
        .cell-sched { color: #3b82f6; font-size: 9px; display: block; margin-top: 2px; }
        .cell-sched-zero { color: #1e2a3a; font-size: 9px; display: block; margin-top: 2px; }

        /* Filter chips */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .filter-chip {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            padding: 3px 10px;
            border-radius: 3px;
            border: 1px solid #2a3038;
            background: #16191f;
            color: #555;
            cursor: pointer;
            transition: all 150ms;
            user-select: none;
        }
        .filter-chip:hover { color: #e0e0e0; border-color: #3a4048; }
        .filter-chip.active { color: #e0e0e0; border-color: #555; background: #1e2330; }
        .filter-chip.active-allow    { color: #22c55e; border-color: rgba(34,197,94,0.35);  background: rgba(34,197,94,0.08); }
        .filter-chip.active-block    { color: #ef4444; border-color: rgba(239,68,68,0.35);  background: rgba(239,68,68,0.08); }
        .filter-chip.active-timer    { color: #f59e0b; border-color: rgba(245,158,11,0.35); background: rgba(245,158,11,0.08); }
        .filter-chip.active-schedule { color: #3b82f6; border-color: rgba(59,130,246,0.35); background: rgba(59,130,246,0.08); }

        @media (max-width: 540px) {
            .log-entry { grid-template-columns: 70px 70px 1fr; gap: 8px; }
            .log-details { display: none; }
            body { padding: 12px; }
            .weekly-table th, .weekly-table td { padding: 6px 2px; font-size: 10px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <a class="back-link" href="/">&#8592; Kids Internet</a>
            <div class="header-divider"></div>
            <div class="header-title"><h1>Activity Log</h1></div>
        </div>
        <div class="header-right">
            <span class="refresh-info" id="refreshInfo">Auto-refresh 10s</span>
            <a class="nav-link" href="/schedule">Schedules</a>
            <a class="nav-link" href="/settings">Settings</a>
        </div>
    </div>

    <!-- Weekly timed-access table -->
    <div id="weeklySection" class="weekly-section" style="display:none;">
        <div class="weekly-label">Timed Access — Last 7 Days
            <span style="color:#f59e0b;margin-left:12px;">&#9679; timed</span>
            <span style="color:#3b82f6;margin-left:8px;">&#9679; scheduled</span>
        </div>
        <table class="weekly-table" id="weeklyTable"></table>
    </div>

    <!-- Today's totals by kid -->
    <div id="todaySummary" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;"></div>

    <div class="filter-bar" id="kidFilterBar"></div>
    <div class="filter-bar" id="typeFilterBar">
        <span class="filter-chip active" onclick="setTypeFilter('all')">All</span>
        <span class="filter-chip" onclick="setTypeFilter('allow')">Allow</span>
        <span class="filter-chip" onclick="setTypeFilter('block')">Block</span>
        <span class="filter-chip" onclick="setTypeFilter('timer')">Timer</span>
        <span class="filter-chip" onclick="setTypeFilter('schedule')">Schedule</span>
    </div>

    <div id="logList" class="log-list">
        <div class="empty-state">Loading...</div>
    </div>

    <script>
        let cachedEntries = [];
        let activeKidFilter = 'all';
        let activeTypeFilter = 'all';

        const ACTION_TYPE = {
            'toggle-allow':    'allow',
            'toggle-block':    'block',
            'allow-all':       'allow',
            'block-all':       'block',
            'timed-allow':     'timer',
            'timed-allow-all': 'timer',
            'timer-expired':   'timer',
            'timer-cancel':    'timer',
            'extend-timer':    'timer',
            'schedule-allow':  'schedule',
            'schedule-block':  'schedule',
            'schedule-toggle': 'schedule',
            'schedules-saved': 'schedule',
            'skip-next':       'schedule',
            'skip-cancel':     'schedule',
            'day-override':    'schedule',
        };

        function applyFilters() {
            return cachedEntries.filter(e => {
                if (activeKidFilter !== 'all' && e.kid !== activeKidFilter) return false;
                if (activeTypeFilter !== 'all' && ACTION_TYPE[e.action] !== activeTypeFilter) return false;
                return true;
            });
        }

        function setKidFilter(name) {
            activeKidFilter = name;
            document.querySelectorAll('#kidFilterBar .filter-chip').forEach(chip => {
                chip.className = 'filter-chip' + (chip.dataset.kid === name ? ' active' : '');
            });
            renderLog(applyFilters());
        }

        function setTypeFilter(type) {
            activeTypeFilter = type;
            document.querySelectorAll('#typeFilterBar .filter-chip').forEach(chip => {
                const t = chip.dataset.type;
                const isActive = t === type;
                chip.className = 'filter-chip' + (isActive ? (type === 'all' ? ' active' : ` active-${type}`) : '');
            });
            renderLog(applyFilters());
        }

        function buildKidFilterBar(entries, kids) {
            // Build ordered kid list from schedule kids, then any extra names from log
            const kidNames = (kids || []).map(k => k.name);
            for (const e of entries) {
                if (e.kid && !kidNames.includes(e.kid)) kidNames.push(e.kid);
            }
            const bar = document.getElementById('kidFilterBar');
            if (!kidNames.length) { bar.innerHTML = ''; return; }
            bar.innerHTML = [
                `<span class="filter-chip active" data-kid="all" onclick="setKidFilter('all')">All</span>`,
                ...kidNames.map(n =>
                    `<span class="filter-chip" data-kid="${n}" onclick="setKidFilter('${n}')">${n}</span>`)
            ].join('');
            // Re-apply active kid chip style
            bar.querySelectorAll('.filter-chip').forEach(chip => {
                if (chip.dataset.kid === activeKidFilter) chip.classList.add('active');
            });
        }

        // Tag type filter chips with data attributes for setTypeFilter
        document.querySelectorAll('#typeFilterBar .filter-chip').forEach((chip, i) => {
            const types = ['all', 'allow', 'block', 'timer', 'schedule'];
            chip.dataset.type = types[i];
        });

        const ACTION_META = {
            'toggle-allow':    { label: 'ALLOWED',       cls: 'action-allow' },
            'toggle-block':    { label: 'BLOCKED',       cls: 'action-block' },
            'timed-allow':     { label: 'TIMED ALLOW',   cls: 'action-timed' },
            'timed-allow-all': { label: 'TIMED ALL',     cls: 'action-timed' },
            'timer-expired':   { label: 'TIMER END',     cls: 'action-block' },
            'timer-cancel':    { label: 'TIMER CANCEL',  cls: 'action-neutral' },
            'allow-all':       { label: 'ALLOW ALL',     cls: 'action-allow' },
            'block-all':       { label: 'BLOCK ALL',     cls: 'action-block' },
            'schedule-allow':  { label: 'SCHED ALLOW',  cls: 'action-allow' },
            'schedule-block':  { label: 'SCHED BLOCK',  cls: 'action-block' },
            'schedule-toggle': { label: 'SCHED TOGGLE', cls: 'action-neutral' },
            'schedules-saved': { label: 'SCHED SAVED',  cls: 'action-neutral' },
            'skip-next':       { label: 'SKIP NEXT',    cls: 'action-block' },
            'skip-cancel':     { label: 'SKIP CANCEL',  cls: 'action-neutral' },
        };

        function relTime(ts) {
            const diff = Date.now() - ts;
            if (diff < 5000)      return 'just now';
            if (diff < 60000)     return `${Math.floor(diff / 1000)}s ago`;
            if (diff < 3600000)   return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000)  return `${Math.floor(diff / 3600000)}h ago`;
            return new Date(ts).toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function absTime(ts) {
            return new Date(ts).toLocaleString([], {
                month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit', second: '2-digit'
            });
        }

        function renderLog(entries) {
            const el = document.getElementById('logList');
            if (!entries.length) {
                el.innerHTML = '<div class="empty-state">No activity yet</div>';
                return;
            }
            el.innerHTML = entries.map(e => {
                const meta = ACTION_META[e.action] || { label: e.action.toUpperCase(), cls: 'action-neutral' };
                return `
                <div class="log-entry">
                    <span class="log-time" title="${absTime(e.ts)}">${relTime(e.ts)}</span>
                    <span class="log-kid">${e.kid || '—'}</span>
                    <span class="log-action ${meta.cls}">${meta.label}</span>
                    <span class="log-details">${e.details || ''}</span>
                </div>`;
            }).join('');
        }

        function fmtMins(m) {
            if (m <= 0) return '0m';
            return m >= 60
                ? `${Math.floor(m/60)}h ${m%60 ? m%60+'m' : ''}`.trim()
                : `${m}m`;
        }

        function scheduledMinsForDay(windows, dayOfWeek) {
            let total = 0;
            for (const w of (windows || [])) {
                if (!w.days || !w.days.includes(dayOfWeek)) continue;
                const [sh, sm] = w.start.split(':').map(Number);
                const [eh, em] = w.end.split(':').map(Number);
                total += (eh * 60 + em) - (sh * 60 + sm);
            }
            return total;
        }

        function renderSummary(entries, kids) {
            const todayStart = new Date(); todayStart.setHours(0,0,0,0);
            const todayDow = new Date().getDay();
            const timedTotals = {}; // kid name → timed-allow minutes
            for (const e of entries) {
                if (e.action !== 'timed-allow' || !e.kid || e.ts < todayStart.getTime()) continue;
                const m = parseInt(e.details) || 0;
                timedTotals[e.kid] = (timedTotals[e.kid] || 0) + m;
            }

            // Build schedule totals for today
            const schedTotals = {}; // kid name → scheduled minutes today
            for (const kid of (kids || [])) {
                if (kid.config && kid.config.enabled) {
                    schedTotals[kid.name] = scheduledMinsForDay(kid.config.windows, todayDow);
                }
            }

            const allKids = new Set([...Object.keys(timedTotals), ...Object.keys(schedTotals)]);
            const el = document.getElementById('todaySummary');
            if (!allKids.size) { el.innerHTML = ''; return; }
            el.innerHTML = [...allKids].map(name => {
                const timed = timedTotals[name] || 0;
                const sched = schedTotals[name] || 0;
                return `
                <div style="
                    background:#16191f;border:1px solid #1a1f28;border-radius:4px;
                    padding:8px 14px;font-family:'Share Tech Mono',monospace;font-size:11px;">
                    <span style="color:#555;font-size:9px;display:block;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;">Today</span>
                    <span style="color:#e0e0e0;font-weight:700;">${name}</span>
                    ${timed ? `<span style="color:#f59e0b;margin-left:10px;">${fmtMins(timed)} timed</span>` : ''}
                    ${sched ? `<span style="color:#3b82f6;margin-left:8px;">${fmtMins(sched)} sched</span>` : ''}
                </div>`;
            }).join('');
        }

        function fmtMinsShort(m) {
            if (!m) return '—';
            return m >= 60
                ? `${Math.floor(m/60)}h${m%60 ? (m%60)+'m' : ''}`
                : `${m}m`;
        }

        function renderWeekly(entries, kids) {
            if (!kids || !kids.length) return;

            // Build day array: 6 days ago → today
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() - i);
                days.push(d);
            }

            // Accumulate timed-allow minutes per kid per day
            const totals = {};
            for (const kid of kids) totals[kid.name] = new Array(7).fill(0);

            for (const e of entries) {
                if (e.action !== 'timed-allow' || !e.kid) continue;
                const mins = parseInt(e.details) || 0;
                const entryDay = new Date(e.ts);
                entryDay.setHours(0, 0, 0, 0);
                const idx = days.findIndex(d => d.getTime() === entryDay.getTime());
                if (idx === -1) continue;
                if (totals[e.kid] !== undefined) totals[e.kid][idx] += mins;
            }

            const dayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const todayIdx = 6; // last column is always today

            const table = document.getElementById('weeklyTable');
            const headerCells = days.map((d, i) => {
                const label = i === todayIdx ? 'Today' : dayLabels[d.getDay()];
                const cls = i === todayIdx ? 'col-today' : '';
                return `<th class="${cls}">${label}<br><span style="color:#2a3038;font-size:9px;">${d.getMonth()+1}/${d.getDate()}</span></th>`;
            }).join('');

            const rows = kids.map(kid => {
                const cells = days.map((d, i) => {
                    const m = totals[kid.name][i];
                    const cls = i === todayIdx ? 'col-today' : '';
                    const valCls = m ? 'cell-mins' : 'cell-zero';
                    const sched = kid.config && kid.config.enabled
                        ? scheduledMinsForDay(kid.config.windows, d.getDay())
                        : 0;
                    const schedHtml = sched
                        ? `<span class="cell-sched">${fmtMinsShort(sched)}</span>`
                        : `<span class="cell-sched-zero">—</span>`;
                    return `<td class="${cls}"><span class="${valCls}">${fmtMinsShort(m)}</span>${schedHtml}</td>`;
                }).join('');
                return `<tr><td class="col-name">${kid.name}</td>${cells}</tr>`;
            }).join('');

            table.innerHTML = `
                <thead><tr><th class="col-name">Kid</th>${headerCells}</tr></thead>
                <tbody>${rows}</tbody>`;

            document.getElementById('weeklySection').style.display = 'block';
        }

        async function fetchLog() {
            try {
                const [logRes, schedRes] = await Promise.all([
                    fetch('/api/log'),
                    fetch('/api/schedules')
                ]);
                if (!logRes.ok) throw new Error();
                const data = await logRes.json();
                cachedEntries = data.log || [];
                const kids = schedRes.ok ? (await schedRes.json()).kids || [] : [];
                renderWeekly(cachedEntries, kids);
                renderSummary(cachedEntries, kids);
                buildKidFilterBar(cachedEntries, kids);
                renderLog(applyFilters());
                document.getElementById('refreshInfo').textContent =
                    'Updated ' + new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' });
            } catch {
                document.getElementById('refreshInfo').textContent = 'Error fetching log';
            }
        }

        fetchLog();
        setInterval(fetchLog, 10000);

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
    </script>
</body>
</html>
